<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<body>
  <button id="get-token-button">get token</button>
  <form id="verify-form">
    <input type="text" name="token">
    <button>驗證</button>
  </form>
  <button id="logout-button">logout</button>
  <br>
  <button id="refresh-token-button">refresh-token</button>
  <br>
  <button id="send-email">send-email</button>

  <script>
    document.getElementById('get-token-button').addEventListener('click', async () => {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch('/verify/token', {
          method: 'GET',
          headers: {
            'Authorization': token,
            'Content-Type': 'application/json'
          }
        });

        const result = await response.json();
        if (response.ok) {
          alert('token: ' + result.token);
        } else {
          alert('token產生失敗: ' + result.error);
        }
      } catch {
        alert('token請求失敗: ' + error.message);
      }
    });

    document.getElementById('verify-form').addEventListener('submit', async function(event) {
      const token = localStorage.getItem('token');

      event.preventDefault();
      
      const formData = new FormData(this);
      const verify_token = formData.get('token');

      try {
        const response = await fetch(`/verify/verify?token=${verify_token}`, {
          method: 'GET',
          headers: {
            'Authorization': token,
            'Content-Type': 'application/json'
          },
        });

        const result = await response.json();
        if (response.ok) {
          alert('驗證成功');
        } else {
          alert('驗證失敗: ' + result.error);
        }
      } catch (error) {
        alert('驗證請求失敗: ' + error.message);
      }
    });

    document.getElementById('logout-button').addEventListener('click', async () => {
      try {
        const token = localStorage.getItem('token');
        const response = await fetch('/auth/logout', {
          method: 'POST',
          headers: {
            'Authorization': token,
            'Content-Type': 'application/json'
          }
        });

        const result = await response.json();
        if (response.ok) {
          localStorage.removeItem('token');
          alert('已登出');
        } else {
          alert('token產生失敗: ' + result.error);
        }
      } catch {
        alert('token請求失敗: ' + error.message);
      }
    });
    
    document.getElementById('refresh-token-button').addEventListener('click', async () => {
      try {
        const response = await fetch('/auth/token', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        const result = await response.json();
        if (response.ok) {
          localStorage.setItem('token', result.accessToken);
          alert('token: ' + result.accessToken);
        } else {
          alert('token產生失敗: ' + result.error);
        }
      } catch {
        alert('token請求失敗: ' + error.message);
      }
    });

    document.getElementById('send-email').addEventListener('click', async () => {
      let verify_token;
      
      try {
        const token = localStorage.getItem('token');
        const response = await fetch('/verify/token', {
          method: 'GET',
          headers: {
            'Authorization': token,
            'Content-Type': 'application/json'
          }
        });

        const result = await response.json();
        if (response.ok) {
          verify_token = result.token;
        } else {
          return alert(result.error);
        }
      } catch (error) {
        return alert(error.message);
      }

      try {
        const token = localStorage.getItem('token');
        const response = await fetch('/verify/send-mail', {
          method: 'POST',
          headers: {
            'Authorization': token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            token: verify_token
          })
        });

        const result = await response.json();
        if (response.ok) {
          alert(result.message);
        } else {
          alert(result.error);
        }
      } catch (error) {
        alert(error.message);
      }
    })
  </script>
</body>
</html>